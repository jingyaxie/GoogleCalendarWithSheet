# 📅 课程同步系统 - 完整使用指南

## 📖 目录

1. [系统简介](#系统简介)
2. [功能特性](#功能特性)
3. [快速开始](#快速开始)
   - [方式一：直接使用脚本](#方式一直接使用脚本)
   - [方式二：作为库使用（推荐）](#方式二作为库使用推荐)
4. [配置说明](#配置说明)
5. [使用方法](#使用方法)
6. [数据格式](#数据格式)
7. [状态表说明](#状态表说明)
8. [时区设置](#时区设置)
9. [常见问题](#常见问题)
10. [注意事项](#注意事项)
11. [技术支持](#技术支持)

---

## 🎯 系统简介

课程同步系统是一个基于 Google Apps Script 的自动化工具，用于将 Google 表格中的课程信息自动同步到 Google 日历，并发送邮件通知给老师和学生。

### 主要功能

- 📊 **多Sheet管理**：支持同时管理多个课程表
- 📧 **邮件通知**：自动发送课程通知邮件
- 📅 **日历同步**：自动创建、更新和删除日历事件
- 🎥 **Google Meet 链接**：自动为每个课程事件添加 Google Meet 视频会议链接
- 🔍 **智能检测**：自动检测课程变化，只处理有变化的记录
- 📝 **状态跟踪**：记录每条课程的处理状态和事件ID
- 🗑️ **删除处理**：自动删除已删除课程的日历事件并发送取消邮件

---

## ✨ 功能特性

### 核心功能

- ✅ **多Sheet支持**：可以同时管理多个课程表，每个表独立配置
- ✅ **自动同步**：一键同步所有配置的课程表
- ✅ **智能更新**：检测课程变化，只更新有变化的记录
- ✅ **邮件通知**：自动发送课程通知邮件给老师和学生
- ✅ **日历集成**：自动创建、更新和删除日历事件
- ✅ **状态跟踪**：记录每条课程的处理状态、事件ID和时间戳
- ✅ **删除处理**：自动删除已删除课程的日历事件并发送取消邮件
- ✅ **事件验证**：自动验证日历事件是否存在，处理手动删除的情况
- ✅ **时区支持**：支持为每个Sheet设置不同的时区
- ✅ **邮件提醒**：支持配置提前多长时间通过邮件提醒上课
- ✅ **Google Meet 链接**：自动为每个课程事件添加 Google Meet 视频会议链接，所有参与者都可以直接加入会议
- ✅ **灵活的日期时间格式**：支持日期+时间组合或只有日期，自动处理全天事件和跨天事件
- ✅ **智能时间处理**：开始时间只填写日期时从 00:00:00 开始，结束时间只填写日期时到 23:59:59 结束

### 用户体验

- 🎨 **自定义菜单**：提供友好的菜单界面，无需手动运行脚本
- 📋 **配置管理**：统一的配置表管理所有课程表
- 📊 **状态查看**：可以方便地查看每个课程表的处理状态
- 🔄 **自动处理**：自动处理记录ID、状态同步等复杂逻辑

---

## 🚀 快速开始

### 方式一：直接使用脚本

#### 步骤 1：创建 Google Apps Script 项目

1. 打开你的 Google 表格
2. 点击菜单：`扩展程序` → `Apps Script`
3. 删除默认代码，将 `syncCalendarWithSheet.js` 中的代码复制粘贴进去
4. 保存项目（可以命名为 "课程日历同步"）

#### 步骤 2：配置表格

**2.1 创建配置表（_SheetConfig）**

创建一个名为 `_SheetConfig` 的 Sheet，用于管理要处理的课程表：

| Sheet名称 | 启用状态 | 组织者日历ID | 老师邮箱 | 学生邮箱 | 时区 | 提醒时间 |
|-----------|----------|------------|----------|----------|------|----------|
| 张三同学课程表 | 是 | jovixiao2022@gmail.com | jovixiao2022@gmail.com | jingyaxiegm1@gmail.com | Asia/Shanghai | 30 |

**2.2 创建课程表**

创建一个课程表 Sheet（名称与配置表中的"Sheet名称"一致），格式如下：

**必需列（必须填写）：**
- **开始时间**：课程开始时间（必须填写）

**可选列：**
- **结束时间**：课程结束时间（可选，如果不填写会使用开始时间的日期，时间设为 23:59:59）

**自定义列（可以自由添加任意字段）：**
除了"开始时间"、"结束时间"和系统自动添加的"记录ID"外，您可以添加任意自定义字段，所有字段都会显示在日历事件的描述中。

示例：

| 课次 | 课程内容/主题 | 开始时间 | 结束时间 | 老师 | 学生 | 地点 | 备注 |
|------|--------------|----------|----------|------|------|------|------|
| 第1次 | 基础线条与构图 | 2025/11/14 09:00 | 2025/11/14 11:30 | 李老师 | 张三 | 教室A | 带画笔 |

#### 步骤 3：授权权限

首次运行脚本时，需要授权以下权限：
- **Google Sheets**：读取和写入表格数据
- **Gmail**：发送邮件
- **Google Calendar**：创建和管理日历事件（包括添加 Google Meet 链接）

授权步骤：
1. 点击运行按钮（▶️）
2. 选择 `main` 函数
3. 点击 `运行`
4. 在弹出的授权对话框中点击 `审查权限`
5. 选择你的 Google 账户
6. 点击 `高级` → `转到 [项目名称]（不安全）`
7. 点击 `允许`

#### 步骤 4：使用

1. 打开 Google 表格
2. 在菜单栏中找到 **📅 课程同步** 菜单
3. 点击 **🔄 执行同步**
4. 在弹出的确认对话框中点击 **是**
5. 等待执行完成，系统会显示完成提示

---

### 方式二：作为库使用（推荐）

这种方式适合需要在多个表格中使用的情况，代码集中管理，易于维护和更新。

#### 步骤 1：发布为库

**1.1 获取脚本ID**

1. 在 Google Apps Script 编辑器中，点击 **"文件"** → **"项目属性"**
2. 在 **"项目属性"** 对话框中，找到 **"脚本 ID"** 字段
3. 复制该脚本ID，这是库的唯一标识符

**1.2 创建版本（可选）**

如果需要使用固定版本（而不是开发模式）：

1. 在 Google Apps Script 编辑器中，点击 **"文件"** → **"管理版本"**
2. 在弹出的对话框中，输入版本说明（例如，"初始版本"）
3. 点击 **"保存新版本"**
4. 版本号会自动生成（1, 2, 3...）

**注意**：如果不创建版本，可以使用 **"开发模式"**，这样会自动使用最新代码。

#### 步骤 2：在新表格中使用

**2.1 添加库**

1. 在 Google Sheets 中打开新表格
2. 点击 **"扩展程序"** → **"Apps Script"**
3. 点击 **"资源"** → **"库"**（或 **"库"** → **"添加库"**）
4. 在弹出的对话框中，粘贴之前复制的库的脚本ID
5. 点击 **"查找"** 或 **"添加"**
6. 在 **"标识符"** 字段中，输入一个简短的名称（例如：`CalendarSyncLib`），用于在代码中引用该库
7. 选择版本：
   - **"开发模式"**：自动使用最新代码（推荐用于开发）
   - **"版本号"**：使用固定版本（推荐用于生产环境）
8. 点击 **"添加"** 或 **"保存"**

**2.2 创建初始化代码**

在新表格的 Apps Script 编辑器中，创建以下代码（也可以直接复制 `userScriptExample.js` 文件中的代码）：

```javascript
/**
 * 当打开表格时自动创建自定义菜单
 */
function onOpen() {
  CalendarSyncLib.createMenu();  // 将 CalendarSyncLib 替换为你设置的库标识符
}

/**
 * 菜单项：执行同步（包装函数）
 * 注意：菜单项函数必须在用户表格中定义，不能直接在库中调用
 */
function menuRunSync() {
  try {
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      '确认执行同步',
      '这将处理所有配置的课程表，在组织者日历上创建事件并邀请老师和学生。\n\n是否继续？',
      ui.ButtonSet.YES_NO
    );
    
    if (response === ui.Button.YES) {
      CalendarSyncLib.main();  // 将 CalendarSyncLib 替换为你设置的库标识符
      ui.alert(
        '同步完成',
        '课程同步已完成，请查看执行日志了解详细信息。',
        ui.ButtonSet.OK
      );
    }
  } catch (error) {
    const ui = SpreadsheetApp.getUi();
    const errorMessage = error.message || error.toString() || '未知错误';
    ui.alert(
      '执行错误',
      '同步过程中发生错误：\n' + errorMessage + '\n\n请查看执行日志了解详细信息。',
      ui.ButtonSet.OK
    );
  }
}

/**
 * 菜单项：查看配置（包装函数）
 */
function menuViewConfig() {
  CalendarSyncLib.menuViewConfig();  // 将 CalendarSyncLib 替换为你设置的库标识符
}

/**
 * 菜单项：查看状态表（包装函数）
 */
function menuViewStatus() {
  CalendarSyncLib.menuViewStatus();  // 将 CalendarSyncLib 替换为你设置的库标识符
}

/**
 * 菜单项：关于（包装函数）
 */
function menuAbout() {
  CalendarSyncLib.menuAbout();  // 将 CalendarSyncLib 替换为你设置的库标识符
}

/**
 * 可选：手动执行同步
 */
function runSync() {
  CalendarSyncLib.main();  // 将 CalendarSyncLib 替换为你设置的库标识符
}
```

**重要说明**：
- 将代码中的 `CalendarSyncLib` 替换为你设置的库标识符
- 菜单项函数（`menuRunSync`, `menuViewConfig`, `menuViewStatus`, `menuAbout`）必须在用户表格中定义
- 这些函数作为包装函数，调用库中的实际函数
- 菜单系统无法直接找到库中的函数，所以需要这些包装函数

**2.3 配置表格**

按照"方式一"中的步骤 2 配置表格（创建配置表和课程表）。

**2.4 授权**

1. 首次使用时，系统会提示授权
2. 点击 **"授权"** 并完成授权流程
3. 授予必要的权限：
   - Google Sheets 访问权限
   - Google Calendar 访问权限
   - 发送邮件权限（用于取消课程通知）

**2.5 使用**

1. 刷新表格页面
2. 应该能看到 **"📅 课程同步"** 菜单
3. 点击菜单中的 **"🔄 执行同步"** 开始处理课程数据

---

## ⚙️ 配置说明

### 配置表（_SheetConfig）

配置表用于管理要处理的课程表列表，必须包含以下列：

#### 必需列（必须填写）

1. **Sheet名称**
   - **说明**：要处理的课程表名称（必须与实际的 Sheet 名称完全一致）
   - **支持的表头名称**：`Sheet名称`、`Sheet Name`、`名称`、`Name`、`Sheet`、`表名`等
   - **示例**：`张三同学课程表`
   - **注意**：必须与实际的 Sheet 名称完全一致，区分大小写

2. **启用状态**
   - **说明**：是否启用该课程表
   - **支持的表头名称**：`启用状态`、`启用`、`Enabled`、`Status`、`是否启用`等
   - **支持的值**：`是`、`启用`、`Yes`、`Enabled`、`True`、`1`、`true`（表示启用）
   - **其他值**：表示不启用（该行会被跳过）
   - **示例**：`是`、`Yes`、`1`

3. **组织者日历ID**
   - **说明**：组织者的 Google 日历 ID（通常是邮箱地址），事件将在此日历上创建，老师和学生将作为受邀者
   - **支持的表头名称**：`组织者日历ID`、`组织者日历`、`Organizer Calendar ID`、`管理员日历ID`、`Admin Calendar ID`等
   - **示例**：`jovixiao2022@gmail.com`
   - **注意**：必须填写，否则该行会被跳过

#### 可选列（可以不填写）

4. **老师邮箱**
   - **说明**：老师的邮箱地址（用于邀请和发送邮件）
   - **支持的表头名称**：`老师邮箱`、`Teacher Email`、`老师邮件`、`TeacherEmail`等
   - **示例**：`teacher@example.com`
   - **注意**：
     - **可选列**：可以不填写，也可以没有这一列
     - 如果不填写或没有这一列，老师将不会收到邀请邮件
     - 事件仍然会正常创建，只是不会邀请老师

5. **学生邮箱**
   - **说明**：学生的邮箱地址（用于邀请和发送邮件）
   - **支持的表头名称**：`学生邮箱`、`Student Email`、`学生邮件`、`StudentEmail`等
   - **示例**：`student@example.com`
   - **注意**：
     - **可选列**：可以不填写，也可以没有这一列
     - 如果不填写或没有这一列，学生将不会收到邀请邮件
     - 事件仍然会正常创建，只是不会邀请学生

6. **时区**
   - **说明**：用于设置该Sheet的时区
   - **支持的表头名称**：`时区`、`Timezone`、`Time Zone`、`TZ`等
   - **示例**：`Asia/Shanghai`、`America/New_York`、`Europe/Paris`
   - **默认值**：如果不填写，会使用默认时区 `Asia/Shanghai`
   - **支持的时区格式**：请参考"时区设置"章节

7. **提醒时间**
   - **说明**：提前多少分钟通过邮件提醒上课（单位：分钟）
   - **支持的表头名称**：`提醒时间`、`Reminder Minutes`、`Reminder`、`提醒`、`邮件提醒`、`Email Reminder`、`提前提醒`、`Minutes Before`等
   - **示例**：`30`（提前30分钟）、`60`（提前60分钟）、`120`（提前2小时）
   - **默认值**：如果不配置或留空，创建事件时不会添加提醒
   - **注意**：提醒会发送给所有参与者（组织者、老师、学生），包括邮件提醒和弹出提醒

**重要提示：**
- ✅ **列的顺序可以随意调整**，只要表头名称正确即可
- ✅ **表头名称支持中英文**，不区分大小写
- ✅ **系统会自动匹配表头**，支持多种变体
- ⚠️ **必需列必须填写**，否则该行会被跳过

### 课程表格式

每个课程表需要包含以下列（开始时间是必需的，其他列都是可选的）：

#### 必需列（必须填写）

1. **开始时间**
   - **说明**：课程开始时间（支持日期+时间组合或只有日期）
   - **支持的表头名称**：`开始时间`、`Start Time`、`开始`、`上课时间`等
   - **支持的格式**：
     - **日期+时间**：`2025/11/14 09:00`、`2025-11-14 09:00`（推荐使用 `2025/11/14 09:00`）
     - **只有日期**：`2025/11/14`、`2025-11-14`（如果只填写日期，时间默认为该日期的 00:00:00）
   - **示例**：
     - 日期+时间：`2025/11/14 09:00`、`2025-11-14 14:30`
     - 只有日期：`2025/11/14`、`2025-11-14`（会从该日期的 00:00:00 开始）
   - **注意**：
     - **必须填写**，否则该行会被跳过
     - 如果只填写日期不填写时间，系统会自动设置为该日期的 00:00:00（零点开始）
     - 支持跨天事件：开始时间和结束时间可以是不同的日期

2. **结束时间**
   - **说明**：课程结束时间（支持日期+时间组合或只有日期）
   - **支持的表头名称**：`结束时间`、`End Time`、`结束`、`下课时间`等
   - **支持的格式**：
     - **日期+时间**：`2025/11/14 18:00`、`2025-11-14 18:00`（推荐使用 `2025/11/14 18:00`）
     - **只有日期**：`2025/11/14`、`2025-11-14`（如果只填写日期，时间默认为该日期的 23:59:59）
   - **示例**：
     - 日期+时间：`2025/11/14 18:00`、`2025-11-14 20:30`
     - 只有日期：`2025/11/14`、`2025-11-14`（会到该日期的 23:59:59 结束）
   - **注意**：
     - **可选**：如果不填写，会使用开始时间的日期，时间设为 23:59:59
     - 如果只填写日期不填写时间，系统会自动设置为该日期的 23:59:59（到该日期的零点结束）
     - 支持跨天事件：开始时间和结束时间可以是不同的日期

#### 自定义列（可以自由添加任意字段）

除了"开始时间"和"结束时间"外，您可以添加任意自定义字段，例如：
- **课次**、**课程内容/主题**、**老师**、**学生**、**地点**、**备注**、**教材**、**作业**等

**自定义字段的特点：**
- ✅ **完全自由**：可以添加任意数量的自定义字段
- ✅ **自动显示**：所有自定义字段（除了"记录ID"）都会自动显示在日历事件的描述中
- ✅ **事件标题**：系统会优先使用"课程内容/主题"相关字段作为日历事件标题，如果没有则使用第一个自定义字段的值
- ✅ **字段排序**：在日历事件描述中，字段会按字母顺序排列，确保一致性
- ✅ **表头灵活**：表头名称支持中英文，不区分大小写

**常用自定义字段示例：**
- **课次**：`课次`、`Lesson`、`课程次数`等
- **课程内容/主题**：`课程内容/主题`、`课程内容`、`主题`、`Course Title`等（推荐用于事件标题）
- **老师**：`老师`、`Teacher`、`教师`等
- **学生**：`学生`、`Student`、`学员`等
- **地点**：`地点`、`Location`、`教室`等
- **备注**：`备注`、`Note`、`说明`等

#### 自动添加的列（系统自动管理）

**记录ID**
- **说明**：系统自动生成并添加到最后一列，用于跟踪记录
- **格式**：`REC_时间戳_随机数`（如：`REC_1762502540720_2532`）
- **注意**：
  - 无需手动添加或修改，系统会自动管理
  - **不会显示在日历事件中**（系统会自动排除）

**重要提示：**
- ✅ **列的顺序可以随意调整**，只要表头名称正确即可
- ✅ **表头名称支持中英文**，不区分大小写
- ✅ **系统会自动匹配表头**，支持多种变体
- ⚠️ **只有"开始时间"是必须的**，其他字段都可以自由自定义
- ⚠️ **"记录ID"字段会被自动排除**，不会显示在日历事件中
- ⚠️ **开始时间和结束时间格式要正确**，否则可能无法解析

---

## 📋 使用方法

### 方法一：使用菜单（推荐）

1. 打开 Google 表格
2. 在菜单栏中找到 **📅 课程同步** 菜单
3. 点击 **🔄 执行同步**
4. 在弹出的确认对话框中点击 **是**
5. 等待执行完成，系统会显示完成提示

### 方法二：手动运行脚本

1. 打开 Google Apps Script 编辑器
2. 选择 `main` 函数
3. 点击运行按钮

### 方法三：设置定时触发器

1. 在 Apps Script 编辑器中
2. 点击左侧的 `触发器` 图标（⏰）
3. 点击 `+ 添加触发器`
4. 配置：
   - 选择要运行的函数：`main`
   - 选择活动来源：`时间驱动`
   - 选择时间触发器类型：`每天定时器` 或 `每周定时器`
   - 选择时间：建议选择非工作时间（如早上8点）
5. 点击 `保存`

### 方法四：在表格中添加按钮

1. 在 Google 表格中
2. 点击 `插入` → `绘图`
3. 绘制一个按钮（如矩形，写上"同步课程"）
4. 点击 `保存并关闭`
5. 将按钮放置在表格中
6. 点击按钮右上角的三点菜单 → `分配脚本`
7. 输入：`main`
8. 点击 `确定`

### 菜单功能说明

#### 🔄 执行同步

- 处理所有启用的课程表
- 发送邮件通知
- 创建或更新日历事件
- 更新状态记录
- 处理已删除的记录

#### 📋 查看配置

- 打开并激活配置表
- 方便查看和编辑配置

#### 📊 查看状态表

- 查看课程处理状态
- 如果有多个课程表，可以选择要查看的表
- 自动显示隐藏的状态表

#### ℹ️ 关于

- 查看系统信息和版本
- 了解系统功能

---

## 📊 数据格式

### 日期时间格式

开始时间和结束时间支持以下格式：

**日期+时间组合（推荐）：**
- `2025/11/14 09:00`（日期和时间用空格分隔）
- `2025-11-14 09:00`
- `2025/11/14 09:00:00`（包含秒）

**只有日期：**
- `2025/11/14`（开始时间会从该日期的 00:00:00 开始）
- `2025-11-14`（结束时间会到该日期的 23:59:59 结束）

**日期格式：**
- 支持 `/` 分隔符：`2025/11/14`
- 支持 `-` 分隔符：`2025-11-14`

**时间格式：**
- `09:00`（推荐）
- `9:00`
- `09:00:00`（包含秒）

### 启用状态格式

支持的启用状态值（表示启用）：
- 中文：`是`、`启用`
- 英文：`Yes`、`Enabled`、`True`
- 数字：`1`
- 布尔值：`true`

其他值表示不启用。

---

## 📊 状态表说明

### 状态表概述

状态表是系统自动创建的隐藏表，用于记录每条课程的处理状态。状态表名称格式：`_StatusLog_{Sheet名称}`

例如，如果课程表名称是"张三同学课程表"，则状态表名称是"`_StatusLog_张三同学课程表`"。

### 状态表结构

状态表包含以下列：

| 列名 | 说明 | 示例 |
|------|------|------|
| 记录ID | 唯一标识符，与课程表的记录ID对应 | `REC_1762590558439_5970` |
| 课次 | 课程次数 | `第1次` |
| 日期 | 从开始时间中提取的日期（用于状态跟踪） | `2025-11-14` |
| Token | 关键信息哈希值，用于检测变化 | `f9e641c53c33b0cf5ac802997833dd57` |
| 组织者日历ID | 组织者日历ID | `jovixiao2022@gmail.com` |
| 组织者日历事件ID | 组织者日历事件ID | `abc123def456@google.com` |
| 组织者日历创建时间 | 组织者日历事件创建时间 | `2025-11-08 16:37:17` |
| 处理状态 | 整体处理状态 | `已完成`、`部分失败`、`失败` |
| 最后更新时间 | 最后更新时间 | `2025-11-08 17:18:30` |

### 处理状态说明

- **已完成**：日历事件创建成功
- **部分失败**：部分操作失败
- **失败**：操作失败

### 查看状态表

1. 点击菜单栏中的 **📅 课程同步** → **📊 查看状态表**
2. 如果有多个课程表，选择要查看的表
3. 系统会自动显示隐藏的状态表

**注意：**
- 状态表是隐藏的，不建议手动修改
- 状态表会自动与课程表同步
- 删除课程表中的记录后，状态表中的对应记录也会被清除

---

## 🌍 时区设置

### 时区配置方法

在配置表 `_SheetConfig` 中添加"时区"列，支持的时区格式如下：

**支持的时区表头名称：**
- `时区`
- `Timezone`
- `Time Zone`
- `TZ`

### 主流时区格式

| 国家/地区 | 时区标识符 | 说明 |
|-----------|-----------|------|
| 中国 | `Asia/Shanghai` | 中国标准时间（UTC+8） |
| 中国香港 | `Asia/Hong_Kong` | 香港时间（UTC+8） |
| 中国台湾 | `Asia/Taipei` | 台湾时间（UTC+8） |
| 日本 | `Asia/Tokyo` | 日本标准时间（UTC+9） |
| 韩国 | `Asia/Seoul` | 韩国标准时间（UTC+9） |
| 新加坡 | `Asia/Singapore` | 新加坡时间（UTC+8） |
| 印度 | `Asia/Kolkata` | 印度标准时间（UTC+5:30） |
| 法国 | `Europe/Paris` | 法国时间（UTC+1，夏令时UTC+2） |
| 英国 | `Europe/London` | 英国时间（UTC+0，夏令时UTC+1） |
| 德国 | `Europe/Berlin` | 德国时间（UTC+1，夏令时UTC+2） |
| 美国东部 | `America/New_York` | 美国东部时间（UTC-5，夏令时UTC-4） |
| 美国西部 | `America/Los_Angeles` | 美国西部时间（UTC-8，夏令时UTC-7） |
| 澳大利亚东部 | `Australia/Sydney` | 澳大利亚东部时间（UTC+10，夏令时UTC+11） |

### 配置示例

| Sheet名称 | 启用状态 | 组织者日历ID | 老师邮箱 | 学生邮箱 | 时区 | 提醒时间 |
|-----------|----------|------------|----------|----------|------|----------|
| 中国课程表 | 是 | organizer@example.com | teacher@example.com | student@example.com | Asia/Shanghai | 30 |
| 美国课程表 | 是 | organizer@example.com | teacher@example.com | student@example.com | America/New_York | 60 |
| 法国课程表 | 是 | organizer@example.com | teacher@example.com | student@example.com | Europe/Paris | 120 |

### 注意事项

- 时区列是可选的，如果不配置，会使用默认时区 `Asia/Shanghai`
- 每个 Sheet 可以有不同的时区
- 时区会影响日期时间的解析和格式化
- 使用 IANA 时区标识符（如 `Asia/Shanghai`），不要使用缩写（如 `CST`、`EST`）
- 系统会自动处理夏令时（DST）转换
- 时区信息会记录在日志中，方便调试

### 如何查找更多时区

- 访问 [IANA 时区数据库](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)
- 或使用 `America/`、`Europe/`、`Asia/` 等前缀搜索

---

## ❓ 常见问题

### Q1: 菜单没有出现怎么办？

**A:** 
1. 刷新页面或重新打开表格
2. 检查是否已保存脚本
3. 尝试手动运行 `onOpen()` 函数
4. 如果使用库模式，检查是否创建了 `onOpen()` 函数并调用了 `CalendarSyncLib.createMenu()`

### Q2: 执行同步时提示"配置表不存在"？

**A:** 
1. 确保已创建名为 `_SheetConfig` 的 Sheet
2. 检查 Sheet 名称是否完全一致（包括下划线）
3. 确保 Sheet 名称没有多余的空格

### Q3: 提示"缺少Sheet名称列"？

**A:** 
1. 检查配置表的第一行是否有表头
2. 确保表头中包含"Sheet名称"列（支持多种变体）
3. 检查表头名称是否正确（不区分大小写）

### Q4: 邮件没有发送？

**A:** 
1. 检查配置表中的邮箱地址是否正确
2. 确保邮箱地址格式正确
3. 检查 Google Apps Script 的权限设置
4. 查看执行日志了解详细错误信息
5. **注意**：系统使用 Google Calendar 的自动邀请邮件，不需要主动发送邮件

### Q5: 日历事件没有创建？

**A:** 
1. 检查配置表中的组织者日历ID是否正确
2. 确保日历已共享给脚本运行账号
3. 检查日历ID格式（通常是邮箱地址）
4. 查看执行日志了解详细错误信息

### Q6: 如何更新已创建的课程？

**A:** 
1. 直接修改课程表中的课程信息
2. 执行同步，系统会自动检测变化
3. 如果关键信息（开始时间、结束时间、主题等）有变化，系统会：
   - 更新日历事件
   - 重新发送邀请邮件

### Q7: 如何删除课程？

**A:** 
1. 在课程表中删除对应的行
2. 执行同步，系统会自动：
   - 删除对应的日历事件
   - 发送取消邮件
   - 清除状态记录

### Q8: 状态表是什么？

**A:** 
- 状态表是系统自动创建的隐藏表，用于记录每条课程的处理状态
- 状态表名称格式：`_StatusLog_{Sheet名称}`
- 可以通过菜单中的"查看状态表"功能查看
- 状态表包含：记录ID、处理状态、事件ID、邮件发送时间等信息

### Q9: 记录ID是什么？

**A:** 
- 记录ID是系统自动生成的唯一标识符
- 用于确保课程表和状态表的一一对应关系
- 即使课程信息发生变化，记录ID保持不变
- 首次同步后，记录ID会自动添加到课程表的最后一列

### Q10: 可以同时处理多个课程表吗？

**A:** 
- 可以！在配置表中添加多行，每行对应一个课程表
- 系统会按顺序处理所有启用的课程表
- 每个课程表使用独立的状态表

### Q11: 如何设置课程提醒？

**A:** 
- 在配置表 `_SheetConfig` 中添加"提醒时间"列
- 填写提前提醒的分钟数，如：`30` 表示提前30分钟提醒，`60` 表示提前60分钟提醒
- 系统会在课程开始前指定的时间通过邮件提醒参与者
- 如果不配置或留空，创建事件时不会添加提醒
- 支持的表头名称：`提醒时间`、`Reminder Minutes`、`Reminder`、`提醒`、`邮件提醒`等

### Q12: Google Meet 链接是什么？如何使用？

**A:** 
- 系统会自动为每个课程事件添加 Google Meet 视频会议链接
- 所有参与者（组织者、老师、学生）都可以在日历事件中看到 Meet 链接
- 点击 Meet 链接即可直接加入视频会议，无需手动创建会议
- Meet 链接会在创建事件时自动生成，无需额外配置
- 如果事件已创建但没有 Meet 链接，系统会在下次同步时自动添加

### Q13: 为什么我看不到 Meet 链接？

**A:** 
- 确保已启用 Calendar API 权限
- 等待几秒钟让 Meet 链接同步到所有参与者的日历
- 刷新日历页面或重新打开事件详情
- 检查执行日志，确认 Meet 链接是否成功添加
- 如果仍然看不到，可以尝试删除事件后重新创建

### Q14: 使用库模式时，提示"找不到脚本函数：menuRunSync"？

**A:** 
- 菜单项函数必须在用户表格中定义，不能直接在库中调用
- 确保已创建包装函数（参考"方式二：作为库使用"章节中的代码示例）
- 检查是否将 `CalendarSyncLib` 替换为你设置的库标识符
- 确保代码已保存

### Q18: 使用库模式时，提示"Cannot call SpreadsheetApp.getUi() from this context"？

**A:** 
- 这个错误通常发生在直接在库中运行 `createMenu()` 函数时
- **解决方法**：`createMenu()` 函数必须在用户表格的 `onOpen()` 函数中调用，不能直接在库中运行
- 确保在用户表格中创建了 `onOpen()` 函数，并在其中调用 `CalendarSyncLib.createMenu()`
- 示例代码：
  ```javascript
  function onOpen() {
    CalendarSyncLib.createMenu();  // 在用户表格的 onOpen() 中调用
  }
  ```
- 如果仍然有问题，请刷新表格页面，让 `onOpen()` 自动执行

### Q15: 如何更新库？

**A:** 
1. 在 Apps Script 编辑器中，点击 **"资源"** → **"库"**
2. 找到已添加的库
3. 点击版本号旁边的下拉菜单
4. 选择新版本或 **"开发模式"**
5. 点击 **"保存"**

### Q16: 开始时间和结束时间应该怎么填写？

**A:** 
- **推荐格式**：`2025/11/14 09:00`（日期和时间用空格分隔）
- **只有日期**：`2025/11/14`（开始时间会从 00:00:00 开始，结束时间会到 23:59:59 结束）
- **跨天事件**：开始时间 `2025/11/14 09:00`，结束时间 `2025/11/19 18:00`（可以是不同的日期）
- **全天事件**：开始时间 `2025/11/14`，结束时间 `2025/11/14`（或留空）
- **注意**：日期和时间之间用空格分隔，日期支持 `/` 或 `-` 分隔符

### Q17: 如果结束时间不填写会怎样？

**A:** 
- 如果结束时间不填写，系统会使用开始时间的日期，时间设为 23:59:59
- 例如：开始时间 `2025/11/14 09:00`，结束时间留空，会创建从 `2025/11/14 09:00` 到 `2025/11/14 23:59:59` 的事件

---

## ⚠️ 注意事项

### 权限要求

首次运行时，系统会提示授权，请点击"允许"。需要以下权限：

- **Google Sheets 权限**：读取和写入表格数据
- **Gmail 权限**：发送邮件
- **Google Calendar 权限**：创建、更新、删除日历事件（包括添加 Google Meet 链接）

### 日历共享

- 确保要创建事件的日历已共享给脚本运行账号
- 共享权限至少需要"可以查看所有活动详情"
- 如果使用邮箱作为日历ID，确保该邮箱的日历已正确共享

### 数据备份

- 建议定期备份配置表和课程表数据
- 状态表会自动管理，无需手动备份
- 删除课程表前，建议先备份数据

### 性能考虑

- 如果课程表数据量很大，执行时间可能较长
- 建议每次处理不超过1000条记录
- 系统会自动跳过已处理且无变化的记录

### 邮件模板

- 系统使用 Google Calendar 的自动邀请邮件，无需手动配置邮件模板
- 创建事件时使用 `sendInvites: true`，Google Calendar 会自动发送邀请邮件给所有受邀者
- 只有在取消课程时才会主动发送取消邮件

### 错误处理

- 如果某条记录处理失败，系统会继续处理其他记录
- 失败记录的状态会标记为"失败"或"部分失败"
- 可以通过查看状态表了解详细的处理结果
- 查看执行日志可以了解详细的错误信息

### 最佳实践

1. **首次使用前**：
   - 先创建一个测试课程表
   - 使用测试数据验证功能
   - 确认邮件和日历事件正常创建

2. **日常使用**：
   - 定期执行同步，保持数据最新
   - 及时处理失败的记录
   - 定期检查状态表

3. **数据维护**：
   - 保持配置表数据准确
   - 及时更新课程信息
   - 删除不需要的课程记录

4. **库模式使用**：
   - 建议使用"开发模式"，这样可以自动使用最新版本
   - 定期检查库是否有更新
   - 保持包装函数代码与库版本兼容

---

## 📞 技术支持

如果遇到问题，请：

1. 查看本文档的"常见问题"部分
2. 检查执行日志中的错误信息
3. 确认配置表和课程表格式是否正确
4. 检查权限设置是否正确
5. 查看 Google Apps Script 执行日志

---

## 📝 更新日志

### 版本 5.0

- ✅ **修复库模式菜单创建错误**：在 `createMenu()` 函数中添加错误处理，避免在库上下文中调用 `SpreadsheetApp.getUi()` 时抛出异常
- ✅ **修复表头处理错误**：修复 `header.trim is not a function` 错误，在 `ensureRecordIdColumn()` 和 `assignRecordIds()` 中，先转换为字符串再调用 `trim()`
- ✅ **改进错误处理**：使代码更健壮，避免因上下文问题导致的异常
- ✅ **更新文档**：添加 Q18 常见问题，说明如何解决库模式下的 UI 错误

### 版本 4.0

- ✅ **优化列结构**：将日期、开始时间、结束时间三列优化为开始时间和结束时间两列
- ✅ **日期时间组合**：开始时间和结束时间支持日期+时间组合（如 `2025/11/14 09:00`）或只有日期（如 `2025/11/14`）
- ✅ **智能时间处理**：
  - 开始时间只填写日期时，自动设置为该日期的 00:00:00
  - 结束时间只填写日期时，自动设置为该日期的 23:59:59
  - 结束时间为空时，使用开始时间的日期，时间设为 23:59:59
- ✅ **跨天事件支持**：开始时间和结束时间可以是不同的日期，支持创建跨天事件
- ✅ **全天事件支持**：如果开始时间和结束时间都只填写日期，会自动创建全天事件
- ✅ **动态自定义字段**：
  - 只有"开始时间"是必须的，"结束时间"可选
  - 支持添加任意数量的自定义字段（如课次、课程内容、老师、学生、地点、备注等）
  - 所有自定义字段（除"记录ID"）自动显示在日历事件描述中
  - 事件标题智能选择：优先使用"课程内容/主题"，否则使用第一个自定义字段
  - 字段按字母顺序排列，确保一致性
- ✅ **向后兼容**：状态表中仍保留日期列（从开始时间中提取），用于状态跟踪

### 版本 3.0

- ✅ 添加 Google Meet 链接支持，自动为每个课程事件添加视频会议链接
- ✅ 使用 Calendar API 创建事件，确保 Meet 链接在创建时就存在
- ✅ 修复表头格式问题，使用 getDisplayValues() 和 cleanHeaderText() 去除格式
- ✅ 改进表头匹配逻辑，支持更宽松的匹配方式
- ✅ 添加详细的调试日志，便于问题排查
- ✅ 确保 Meet 链接对所有参与者可见（使用 sendUpdates: 'all'）
- ✅ 添加时区支持，确保日期时间正确解析
- ✅ 支持作为 Google Apps Script 库使用
- ✅ 添加 createMenu() 函数，支持外部调用
- ✅ 创建用户脚本示例文件

### 版本 2.0

- ✅ 支持多Sheet配置
- ✅ 从配置表读取邮箱和日历ID
- ✅ 简化主表格式
- ✅ 添加自定义菜单
- ✅ 改进表头匹配逻辑
- ✅ 支持动态时区配置
- ✅ 添加事件验证功能
- ✅ 改进状态记录逻辑
- ✅ 修复日期对象误写入事件ID的问题
- ✅ 改进事件ID验证和格式化
- ✅ 添加速率限制处理和重试机制
- ✅ 支持配置提醒时间，自动添加邮件提醒

### 版本 1.0

- ✅ 基础功能实现
- ✅ 单Sheet支持
- ✅ 邮件和日历同步
- ✅ 状态跟踪

---

**最后更新：** 2025年

**文档版本：** 5.0

