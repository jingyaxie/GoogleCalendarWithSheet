# 课程日历同步脚本使用说明

## 功能概述

这个 Google Apps Script 脚本可以：
1. 从 Google 表格读取课程信息
2. 自动发送邮件通知给老师和学生
3. 在组织者日历上创建课程事件，老师和学生作为受邀者
4. 自动为每个课程事件添加 Google Meet 视频会议链接
5. 在隐藏表中记录处理状态，避免重复处理

## 安装步骤

### 1. 创建 Google Apps Script 项目

1. 打开你的 Google 表格
2. 点击菜单：`扩展程序` → `Apps Script`
3. 删除默认代码，将 `syncCalendarWithSheet.js` 中的代码复制粘贴进去
4. 保存项目（可以命名为 "课程日历同步"）

### 2. 配置表格

#### 2.1 创建配置表（_SheetConfig）

创建一个名为 `_SheetConfig` 的 Sheet，用于管理要处理的课程表：

| Sheet名称 | 启用状态 | 组织者日历ID | 老师邮箱 | 学生邮箱 | 时区 | 提醒时间 |
|-----------|----------|------------|----------|----------|------|----------|
| 张三同学课程表 | 是 | jovixiao2022@gmail.com | jovixiao2022@gmail.com | jingyaxiegm1@gmail.com | Asia/Shanghai | 30 |

**重要说明：**
- ✅ **列的顺序可以随意调整**，只要表头名称正确即可
- ✅ **表头名称支持中英文**，不区分大小写
- ✅ **系统会自动匹配表头**，支持多种变体

#### 2.2 创建课程表

创建一个课程表 Sheet（名称与配置表中的"Sheet名称"一致），格式如下：

| 课次 | 日期 | 课程内容/主题 | 开始时间 | 结束时间 | 老师 | 学生 |
|------|------|--------------|----------|----------|------|------|
| 第1次 | 2025/11/14 | 基础线条与构图 | 09:00 | 11:30 | 李老师 | 张三 |

**重要说明：**
- ✅ **列的顺序可以随意调整**，只要表头名称正确即可
- ✅ **表头名称支持中英文**，不区分大小写
- ✅ **系统会自动添加"记录ID"列**（用于跟踪记录，无需手动添加）

### 3. 配置脚本参数（可选）

如果需要修改默认配置，可以在脚本顶部修改 `CONFIG` 对象：

```javascript
const CONFIG = {
  MAIN_SHEET_NAME: 'Sheet1',  // 主表名称
  STATUS_SHEET_NAME: '_StatusLog',  // 隐藏状态表名称
  TIMEZONE: 'Asia/Shanghai',  // 时区设置
  // ...
};
```

### 4. 授权权限

首次运行脚本时，需要授权以下权限：
- **Google Sheets**：读取和写入表格数据
- **Gmail**：发送邮件
- **Google Calendar**：创建和管理日历事件（包括添加 Google Meet 链接）

授权步骤：
1. 点击运行按钮（▶️）
2. 选择 `main` 函数
3. 点击 `运行`
4. 在弹出的授权对话框中点击 `审查权限`
5. 选择你的 Google 账户
6. 点击 `高级` → `转到 [项目名称]（不安全）`
7. 点击 `允许`

## 使用方法

### 方法1：使用菜单（推荐）

1. 打开 Google 表格
2. 在菜单栏中找到 **📅 课程同步** 菜单
3. 点击 **🔄 执行同步**
4. 在弹出的确认对话框中点击 **是**
5. 等待执行完成，系统会显示完成提示

### 方法2：手动执行

1. 在 Apps Script 编辑器中
2. 选择 `main` 函数
3. 点击运行按钮（▶️）
4. 查看执行日志了解处理结果

### 方法3：设置定时触发器

1. 在 Apps Script 编辑器中
2. 点击左侧的 `触发器` 图标（⏰）
3. 点击 `+ 添加触发器`
4. 配置：
   - 选择要运行的函数：`main`
   - 选择活动来源：`时间驱动`
   - 选择时间触发器类型：`每天定时器` 或 `每周定时器`
   - 选择时间：建议选择非工作时间（如早上8点）
5. 点击 `保存`

### 方法4：在表格中添加按钮

1. 在 Google 表格中
2. 点击 `插入` → `绘图`
3. 绘制一个按钮（如矩形，写上"同步课程"）
4. 点击 `保存并关闭`
5. 将按钮放置在表格中
6. 点击按钮右上角的三点菜单 → `分配脚本`
7. 输入：`main`
8. 点击 `确定`

## 功能说明

### 主函数

- **`main()`**: 主执行函数，处理所有课程记录

### 处理流程

1. 从配置表 `_SheetConfig` 读取要处理的课程表列表
2. 对每个启用的课程表执行：
   - 读取课程数据
   - 检查隐藏状态表，过滤出未处理或需要更新的记录
   - 对每条记录执行：
     - 在组织者日历上创建事件（包含 Google Meet 链接）
     - 自动邀请老师和学生（作为受邀者）
     - 系统自动发送邀请邮件给老师和学生
     - 更新状态记录
   - 处理已删除的记录（删除日历事件并发送取消邮件）
3. 输出处理结果统计

### 状态记录

脚本会自动为每个课程表创建一个隐藏状态表 `_StatusLog_{Sheet名称}`，记录每条课程的处理状态：
- 记录ID（与课程表一一对应）
- 日历事件ID和创建时间
- 处理状态（已完成/部分失败/失败）
- 最后更新时间

### 幂等性

脚本具有幂等性设计：
- 已成功处理的记录不会重复处理
- 可以安全地多次运行脚本
- 失败的记录可以重新处理

## 测试函数

### 测试读取数据

```javascript
testReadData()
```
测试读取表格数据，查看是否正确解析。

### 测试单条记录

```javascript
testSingleRecord()
```
测试处理第一条课程记录，用于调试。

## 邮件模板

邮件会自动发送给老师和学生，包含以下信息：
- 课程主题
- 日期和时间
- 老师和学生信息
- 提示课程已添加到日历

## 日历事件

创建的日历事件包含：
- 课程主题作为标题
- 完整的课程信息作为描述
- 在组织者日历上创建，老师和学生作为受邀者
- **Google Meet 视频会议链接**（自动添加，所有参与者都可以看到）
- 自动发送邀请邮件给老师和学生
- 提醒设置（如果配置了提醒时间）：
  - 邮件提醒（提前指定时间）
  - 弹出提醒（提前指定时间）

## 错误处理

- 如果某个操作失败（如邮件发送失败），会记录错误信息
- 其他操作会继续执行
- 状态会标记为"部分失败"或"失败"
- 可以在日志中查看详细错误信息

## 查看日志

1. 在 Apps Script 编辑器中
2. 点击 `执行` 标签
3. 查看执行日志和错误信息

## 常见问题

### Q: 提示"找不到主表"
A: 检查 `CONFIG.MAIN_SHEET_NAME` 是否与你的表格名称一致。

### Q: 邮件发送失败
A: 检查邮箱地址是否正确，确保有 Gmail 发送权限。

### Q: 日历事件创建失败
A: 检查日历授权ID是否正确，确保有访问该日历的权限。

### Q: 如何重新处理失败的记录？
A: 在隐藏状态表中，将"处理状态"列改为"失败"或删除该行，然后重新运行脚本。

### Q: 如何修改邮件模板？
A: 系统使用 Google Calendar 的自动邀请邮件，无需手动配置邮件模板。

### Q: 时区设置
A: 可以在配置表的"时区"列中为每个课程表设置不同的时区，如 `Asia/Shanghai`、`Europe/Paris`、`America/New_York` 等。如果不配置，默认使用 `Asia/Shanghai`。

### Q: Google Meet 链接是什么？
A: 系统会自动为每个课程事件添加 Google Meet 视频会议链接，所有参与者（组织者、老师、学生）都可以在日历事件中看到并直接加入会议。

### Q: 为什么我看不到 Meet 链接？
A: 
- 确保已启用 Calendar API 权限
- 等待几秒钟让 Meet 链接同步到所有参与者的日历
- 刷新日历页面或重新打开事件详情
- 检查执行日志，确认 Meet 链接是否成功添加

## 注意事项

1. **首次运行前**：确保表格格式正确，包含所有必要的列
2. **权限授权**：首次运行需要完整授权，请仔细阅读权限说明
3. **日历访问**：确保日历授权ID对应的日历可以被访问
4. **批量处理**：如果记录很多，可能需要较长时间，请耐心等待
5. **隐藏表**：不要手动删除或修改隐藏状态表，以免影响功能

## 技术支持

如有问题，请查看：
- Apps Script 执行日志
- 隐藏状态表中的错误信息
- Google Apps Script 官方文档

