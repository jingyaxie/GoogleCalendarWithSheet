# 技术方案设计文档

## 功能需求
1. 从Google表格读取课程信息
2. 发送课程时间邮件给老师和学生
3. 通过授权的日历ID将事件添加到老师和学生的日历中
4. 在隐藏sheet中记录辅助信息（发送状态、事件ID等）

## 技术架构

### 1. 使用的Google APIs
- **Google Sheets API v4**: 读取和写入表格数据
- **Gmail API**: 发送邮件通知
- **Google Calendar API v3**: 创建和管理日历事件
- **OAuth2**: 用户授权认证

### 2. 数据流程

```
Google Sheet (主表)
    ↓ 读取课程数据
脚本处理
    ↓
    ├─→ 发送邮件 (Gmail API)
    │   ├─→ 老师邮箱
    │   └─→ 学生邮箱
    │
    └─→ 创建日历事件 (Calendar API)
        ├─→ 老师日历 (使用老师日历授权ID)
        └─→ 学生日历 (使用学生日历授权ID)
            ↓
    记录状态到隐藏Sheet
```

### 3. 数据结构设计

#### 主Sheet结构（已有）
| 列名 | 说明 | 示例 |
|------|------|------|
| 课次 | 课程序号 | 第1次 |
| 日期 | 课程日期 | 2025/11/13 |
| 课程内容/主题 | 课程主题 | 基础线条与构图 |
| 老师 | 老师姓名 | 李老师 |
| 老师邮箱 | 老师邮箱地址 | jovixiao2022@gmail.com |
| 学生 | 学生姓名 | 张三 |
| 学生邮箱 | 学生邮箱地址 | jingyaxiegm@gmail.com |
| 开始时间 | 课程开始时间 | 10:00 |
| 结束时间 | 课程结束时间 | 11:30 |
| 老师日历授权ID | 老师日历账户 | jovixiao2022@gmail.com |
| 学生日历授权ID | 学生日历账户 | jingyaxiegm@gmail.com |

#### 隐藏Sheet结构（新建：`_StatusLog`）
| 列名 | 说明 | 示例 |
|------|------|------|
| 课次 | 课程序号（关联主表） | 第1次 |
| 日期 | 课程日期 | 2025/11/13 |
| 老师邮件状态 | 邮件发送状态 | 已发送/失败 |
| 老师邮件发送时间 | 邮件发送时间戳 | 2025-01-15 10:30:00 |
| 老师日历事件ID | 老师日历中的事件ID | abc123xyz |
| 老师日历创建时间 | 日历事件创建时间 | 2025-01-15 10:30:05 |
| 学生邮件状态 | 邮件发送状态 | 已发送/失败 |
| 学生邮件发送时间 | 邮件发送时间戳 | 2025-01-15 10:30:00 |
| 学生日历事件ID | 学生日历中的事件ID | def456uvw |
| 学生日历创建时间 | 日历事件创建时间 | 2025-01-15 10:30:05 |
| 处理状态 | 整体处理状态 | 已完成/部分失败/失败 |
| 最后更新时间 | 记录更新时间 | 2025-01-15 10:30:10 |

### 4. 核心功能模块

#### 4.1 初始化模块
- 加载Google APIs客户端库
- OAuth2认证配置
- 获取访问令牌（需要用户授权）

#### 4.2 数据读取模块
- 连接Google Sheets
- 读取主表数据（从第2行开始，第1行为表头）
- 解析日期和时间格式
- 过滤已处理的数据（通过隐藏sheet判断）

#### 4.3 邮件发送模块
- 构建邮件内容（HTML格式）
  - 课程信息
  - 日期和时间
  - 对方信息（老师/学生）
- 使用Gmail API发送邮件
- 记录发送状态

#### 4.4 日历事件创建模块
- 构建日历事件对象
  - 标题：课程内容/主题
  - 开始/结束时间（结合日期和时间）
  - 描述：包含老师和学生信息
  - 参与者：可选的邮箱邀请
- 使用Calendar API创建事件
  - 需要为每个日历授权ID分别创建
- 记录事件ID

#### 4.5 状态记录模块
- 在隐藏sheet中记录处理状态
- 支持更新已存在的记录
- 错误处理和重试机制

### 5. 技术实现细节

#### 5.1 依赖库
```javascript
// Google APIs客户端库
const { google } = require('googleapis');
// 或者使用 Apps Script 内置服务
```

#### 5.2 OAuth2配置
- 需要创建Google Cloud项目
- 启用Sheets API、Gmail API、Calendar API
- 配置OAuth2凭据
- 获取刷新令牌（Refresh Token）

#### 5.3 时间处理
- 日期格式：`2025/11/13` → `2025-11-13`
- 时间格式：`10:00` → 需要转换为ISO 8601格式
- 时区处理：建议使用Asia/Shanghai或UTC

#### 5.4 错误处理
- API调用失败重试机制
- 部分失败时的回滚策略
- 详细的错误日志记录

#### 5.5 幂等性设计
- 通过隐藏sheet判断是否已处理
- 避免重复发送邮件和创建事件
- 支持手动重新处理失败记录

### 6. 执行流程

```
1. 初始化
   ├─ 加载配置
   ├─ OAuth2认证
   └─ 连接Google Sheets

2. 读取数据
   ├─ 读取主表数据
   ├─ 读取隐藏sheet状态
   └─ 过滤未处理/需要更新的记录

3. 处理每条记录
   ├─ 发送老师邮件
   ├─ 创建老师日历事件
   ├─ 发送学生邮件
   ├─ 创建学生日历事件
   └─ 更新状态记录

4. 完成
   └─ 输出处理结果统计
```

### 7. 配置需求

#### 7.1 环境变量/配置
- `SPREADSHEET_ID`: Google表格ID
- `MAIN_SHEET_NAME`: 主表名称（默认：Sheet1）
- `STATUS_SHEET_NAME`: 隐藏表名称（默认：_StatusLog）
- `CLIENT_ID`: OAuth2客户端ID
- `CLIENT_SECRET`: OAuth2客户端密钥
- `REFRESH_TOKEN`: OAuth2刷新令牌

#### 7.2 权限范围（Scopes）
- `https://www.googleapis.com/auth/spreadsheets` - 读写表格
- `https://www.googleapis.com/auth/gmail.send` - 发送邮件
- `https://www.googleapis.com/auth/calendar` - 管理日历

### 8. 安全考虑

1. **凭据管理**
   - 使用环境变量存储敏感信息
   - 不要将凭据提交到代码仓库

2. **权限最小化**
   - 只请求必要的API权限
   - 使用服务账户（如果适用）

3. **错误信息**
   - 避免在错误日志中暴露敏感信息

### 9. 扩展性考虑

1. **批量处理**
   - 支持批量处理多条记录
   - 添加处理进度显示

2. **通知功能**
   - 处理完成后发送汇总报告
   - 失败记录通知

3. **定时执行**
   - 支持定时触发（如每天自动处理新课程）
   - 使用Google Apps Script触发器或外部调度

## 实现方式选择

### 方案A：Google Apps Script（推荐）
- **优点**：
  - 无需服务器，直接在Google云端运行
  - 内置Google APIs，无需额外认证配置
  - 可以直接访问当前表格
  - 支持定时触发器
- **缺点**：
  - 执行时间限制（6分钟）
  - 需要手动部署

### 方案B：Node.js脚本
- **优点**：
  - 更灵活的开发和调试
  - 可以使用本地工具和库
  - 无执行时间限制
- **缺点**：
  - 需要配置OAuth2
  - 需要服务器或本地运行
  - 需要管理凭据

## 推荐方案

**推荐使用Google Apps Script**，因为：
1. 与Google Sheets无缝集成
2. 无需复杂的OAuth2配置
3. 可以直接访问当前表格
4. 支持定时自动执行

## 下一步

1. 确认技术方案
2. 选择实现方式（Apps Script 或 Node.js）
3. 准备Google Cloud项目配置（如需要）
4. 开始开发实现

